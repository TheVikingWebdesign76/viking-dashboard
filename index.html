<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking N8N - Client Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .client-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        input {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
        }

        button {
            padding: 12px 24px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard.active {
            display: grid;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .client-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.8);
            font-size: 14px;
            padding: 8px 16px;
            display: none;
        }

        .logout-btn.active {
            display: block;
        }

        .admin-panel {
            border: 2px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            grid-column: 1 / -1;
        }

        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ff6b35;
        }

        .admin-section h4 {
            margin-bottom: 15px;
            color: #ff6b35;
            font-size: 1.1rem;
        }

        .create-client-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row input, .form-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
        }

        .form-row input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .admin-btn {
            background: #ff6b35;
            padding: 12px 20px;
            font-size: 14px;
        }

        .admin-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .setup-link-container {
            background: rgba(74, 222, 128, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4ade80;
        }

        .link-display {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .link-display input {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 5px;
        }

        .copy-btn {
            padding: 10px 15px;
            background: #4ade80;
            font-size: 12px;
        }

        .setup-instructions {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .success-message {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4ade80;
        }

        .clients-list {
            display: grid;
            gap: 10px;
        }

        .client-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-info span {
            display: block;
            margin-bottom: 5px;
        }

        .client-actions {
            display: flex;
            gap: 10px;
        }

        .client-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .client-input {
                flex-direction: column;
            }
            
            input {
                min-width: 250px;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚öîÔ∏è The Viking Webdesign</div>
            <div>N8N Lead Generation & Email Marketing Dashboard</div>
        </div>

        <div class="login-section" id="loginSection">
            <h2>üîê Secure Client Login</h2>
            <p style="margin-bottom: 20px;">Enter your credentials to access your dashboard</p>
            <div class="client-input">
                <input type="text" id="clientId" placeholder="Client ID" />
                <input type="password" id="clientPassword" placeholder="Password" />
                <button onclick="authenticateClient()" id="loginBtn">
                    <span id="loginText">üìä Login</span>
                </button>
            </div>
            <div id="errorMessage"></div>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Admin Panel (Only for VIKING001) -->
            <div class="card admin-panel" id="adminPanel" style="display: none;">
                <h3>‚öîÔ∏è Admin Panel</h3>
                
                <!-- Create Client Section -->
                <div class="admin-section">
                    <h4>üë• Create New Client</h4>
                    <div class="create-client-form">
                        <div class="form-row">
                            <input type="text" id="newClientId" placeholder="Client ID (e.g: CLIENT004)" />
                            <input type="text" id="newClientName" placeholder="Client Name" />
                        </div>
                        <div class="form-row">
                            <select id="newClientPackage">
                                <option value="Basic Email Marketing">Basic Email Marketing</option>
                                <option value="Pro Lead Generation">Pro Lead Generation</option>
                                <option value="Enterprise Solution">Enterprise Solution</option>
                            </select>
                            <input type="text" id="tempPassword" placeholder="Temporary Password" />
                        </div>
                        <button onclick="createNewClient()" id="createClientBtn" class="admin-btn">
                            <span id="createClientText">üÜï Create Client</span>
                        </button>
                    </div>
                    <div id="createClientResult"></div>
                </div>

                <!-- Generated Setup Link -->
                <div class="admin-section" id="setupLinkSection" style="display: none;">
                    <h4>üîó Client Setup Link</h4>
                    <div class="setup-link-container">
                        <p>Send this link to your new client:</p>
                        <div class="link-display">
                            <input type="text" id="setupLink" readonly />
                            <button onclick="copySetupLink()" class="copy-btn">üìã Copy</button>
                        </div>
                        <p class="setup-instructions">
                            The client will use this link to set their own secure password.
                        </p>
                    </div>
                </div>

                <!-- Client Management -->
                <div class="admin-section">
                    <h4>üìä Client Overview</h4>
                    <div id="clientsList">
                        <div class="loading-clients">Loading clients...</div>
                    </div>
                </div>
            </div>

            <!-- Client Info -->
            <div class="card">
                <h3>üë§ Client Information</h3>
                <div class="client-info">
                    <div><strong>Client:</strong> <span id="clientName">-</span></div>
                    <div><strong>Package:</strong> <span id="clientPackage">-</span></div>
                    <div><strong>Active since:</strong> <span id="clientSince">-</span></div>
                    <div><strong>Session:</strong> <span id="sessionInfo">Secure connection</span></div>
                </div>
            </div>

            <!-- Workflow Statistics -->
            <div class="card">
                <h3>‚öôÔ∏è N8N Workflow Status</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="activeWorkflows">-</div>
                        <div class="stat-label">Active Workflows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalExecutions">-</div>
                        <div class="stat-label">Total Executions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="successRate">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lastRun">-</div>
                        <div class="stat-label">Last Run</div>
                    </div>
                </div>
            </div>

            <!-- Lead Generation -->
            <div class="card">
                <h3>üéØ Lead Generation (Today)</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="newLeads">-</div>
                        <div class="stat-label">New Leads</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="qualifiedLeads">-</div>
                        <div class="stat-label">Qualified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalLeads">-</div>
                        <div class="stat-label">Total Database</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="conversionRate">-</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                </div>
            </div>

            <!-- Email Campaigns -->
            <div class="card">
                <h3>üìß Email Campaign Results</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="emailsSent">-</div>
                        <div class="stat-label">Emails Sent</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsOpened">-</div>
                        <div class="stat-label">Opened</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsClicked">-</div>
                        <div class="stat-label">Clicked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsReplied">-</div>
                        <div class="stat-label">Replied</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="logout-btn" id="logoutBtn" onclick="logout()">üö™ Logout</button>
    </div>

    <script>
        // N8N API Configuration
        const N8N_API_BASE = 'https://n8n.thevikingwebdesign.com/webhook';
        
        let currentSession = null;

        // Authentication function with debug logging
        async function authenticateClient() {
            const clientId = document.getElementById('clientId').value.trim();
            const password = document.getElementById('clientPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('errorMessage');
            
            // Clear previous errors
            errorDiv.innerHTML = '';
            
            // Validation
            if (!clientId || !password) {
                showError('Please enter both Client ID and Password');
                return;
            }
            
            // Show loading
            loginBtn.disabled = true;
            document.getElementById('loginText').innerHTML = '<span class="loading"></span> Authenticating...';
            
            try {
                console.log('Attempting N8N authentication...');
                
                // Call N8N authentication API
                const response = await fetch(`${N8N_API_BASE}/client-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        password: password
                    })
                });
                
                console.log('N8N Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('N8N Response data:', data);
                
                if (data.success) {
                    // Authentication successful
                    console.log('‚úÖ N8N Authentication successful');
                    currentSession = data;
                    showDashboard(data);
                    loadDemoData(data.client_id || clientId);
                } else {
                    // Authentication failed
                    console.log('‚ùå N8N Authentication failed:', data.message);
                    showError(data.message || 'Invalid credentials');
                }
                
            } catch (error) {
                console.error('N8N API error:', error);
                console.log('üîÑ Falling back to local authentication');
                
                // Fallback to local authentication
                const localAuth = authenticateLocally(clientId, password);
                if (localAuth.success) {
                    console.log('‚úÖ Local authentication successful');
                    currentSession = localAuth;
                    showDashboard(localAuth);
                    loadDemoData(localAuth.client_id);
                } else {
                    console.log('‚ùå Local authentication failed');
                    showError('Connection error. Please check your credentials and try again.');
                }
            } finally {
                // Reset button
                loginBtn.disabled = false;
                document.getElementById('loginText').innerHTML = 'üìä Login';
            }
        }
        
        // Local fallback authentication
        function authenticateLocally(clientId, password) {
            const credentials = {
                'VIKING001': { password: 'viking2025', name: 'The Viking Webdesign', package: 'Owner Full Access' },
                'CLIENT001': { password: 'client123', name: 'ABC Company B.V.', package: 'Pro Lead Generation' },
                'CLIENT002': { password: 'startup456', name: 'XYZ Startup', package: 'Basic Email Marketing' }
            };
            
            const client = credentials[clientId.toUpperCase()];
            if (client && client.password === password) {
                return {
                    success: true,
                    client_id: clientId.toUpperCase(),
                    client_name: client.name,
                    package_type: client.package,
                    active_since: '2025-07-04',
                    session_token: `local_${clientId}_${Date.now()}`
                };
            }
            
            return { success: false, message: 'Invalid credentials' };
        }
        
        // Show dashboard after successful login
        function showDashboard(sessionData) {
            console.log('üìä Showing dashboard for:', sessionData.client_name);
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('logoutBtn').classList.add('active');
            
            // Show admin panel only for VIKING001
            if (sessionData.client_id === 'VIKING001') {
                console.log('‚öîÔ∏è Showing admin panel');
                document.getElementById('adminPanel').style.display = 'block';
                loadClientsList();
            }
            
            // Update client info
            document.getElementById('clientName').textContent = sessionData.client_name;
            document.getElementById('clientPackage').textContent = sessionData.package_type;
            document.getElementById('clientSince').textContent = sessionData.active_since;
            document.getElementById('sessionInfo').textContent = 'Secure connection ‚úÖ';
        }
        
        // Load demo data
        function loadDemoData(clientId) {
            console.log('üìà Loading demo data for:', clientId);
            
            const demoData = {
                'VIKING001': { workflows: 8, executions: 1247, newLeads: 23, emailsSent: 156 },
                'CLIENT001': { workflows: 5, executions: 892, newLeads: 15, emailsSent: 98 },
                'CLIENT002': { workflows: 3, executions: 445, newLeads: 8, emailsSent: 45 }
            };
            
            const data = demoData[clientId] || demoData['CLIENT001'];
            
            document.getElementById('activeWorkflows').textContent = data.workflows;
            document.getElementById('totalExecutions').textContent = data.executions.toLocaleString();
            document.getElementById('successRate').textContent = '98.2%';
            document.getElementById('newLeads').textContent = data.newLeads;
            document.getElementById('qualifiedLeads').textContent = Math.floor(data.newLeads * 0.8);
            document.getElementById('totalLeads').textContent = '1,456';
            document.getElementById('conversionRate').textContent = '12.8%';
            document.getElementById('emailsSent').textContent = data.emailsSent;
            document.getElementById('emailsOpened').textContent = Math.floor(data.emailsSent * 0.57);
            document.getElementById('emailsClicked').textContent = Math.floor(data.emailsSent * 0.15);
            document.getElementById('emailsReplied').textContent = Math.floor(data.emailsSent * 0.04);
            document.getElementById('lastRun').textContent = '2 min';
        }
        
        // Error display
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
        }
        
        // Logout function
        function logout() {
            console.log('üö™ Logging out');
            currentSession = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('logoutBtn').classList.remove('active');
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('clientId').value = '';
            document.getElementById('clientPassword').value = '';
            document.getElementById('errorMessage').innerHTML = '';
        }
        
        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('dashboard').classList.contains('active')) {
                authenticateClient();
            }
        });
        
        // Create new client via N8N API
        async function createNewClient() {
            const clientId = document.getElementById('newClientId').value.trim().toUpperCase();
            const clientName = document.getElementById('newClientName').value.trim();
            const packageType = document.getElementById('newClientPackage').value;
            const tempPassword = document.getElementById('tempPassword').value.trim();
            const createBtn = document.getElementById('createClientBtn');
            const resultDiv = document.getElementById('createClientResult');
            
            // Clear previous results
            resultDiv.innerHTML = '';
            
            // Validation
            if (!clientId || !clientName) {
                showCreateResult('Please fill in Client ID and Client Name', 'error');
                return;
            }
            
            if (clientId.length < 3) {
                showCreateResult('Client ID must be at least 3 characters', 'error');
                return;
            }
            
            if (!tempPassword || tempPassword.length < 6) {
                showCreateResult('Temporary password must be at least 6 characters', 'error');
                return;
            }
            
            // Show loading
            createBtn.disabled = true;
            document.getElementById('createClientText').innerHTML = '<span class="loading"></span> Creating...';
            
            try {
                // Call N8N add-client API
                const response = await fetch(`${N8N_API_BASE}/add-client`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.session_token}`
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_name: clientName,
                        package_type: packageType,
                        password: tempPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Client created successfully
                    showCreateResult(`‚úÖ Client ${clientId} created successfully!`, 'success');
                    
                    // Generate setup link
                    const setupUrl = generateSetupLink(clientId, tempPassword);
                    showSetupLink(setupUrl);
                    
                    // Clear form
                    clearCreateForm();
                    
                    // Reload clients list
                    setTimeout(() => loadClientsList(), 1000);
                    
                } else {
                    showCreateResult(`‚ùå ${data.message || 'Failed to create client'}`, 'error');
                }
                
            } catch (error) {
                console.error('Create client error:', error);
                showCreateResult('‚ùå Connection error. Please try again.', 'error');
            } finally {
                // Reset button
                createBtn.disabled = false;
                document.getElementById('createClientText').innerHTML = 'üÜï Create Client';
            }
        }
        
        // Generate setup link for new client
        function generateSetupLink(clientId, tempPassword) {
            const baseUrl = 'https://thevikingwebdesign76.github.io/viking-dashboard/';
            const setupParams = btoa(JSON.stringify({
                client_id: clientId,
                temp_password: tempPassword,
                setup_mode: true,
                expires: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
            }));
            
            return `${baseUrl}?setup=${setupParams}`;
        }
        
        // Show setup link to admin
        function showSetupLink(setupUrl) {
            document.getElementById('setupLink').value = setupUrl;
            document.getElementById('setupLinkSection').style.display = 'block';
        }
        
        // Copy setup link to clipboard
        function copySetupLink() {
            const setupLink = document.getElementById('setupLink');
            setupLink.select();
            setupLink.setSelectionRange(0, 99999); // For mobile
            
            try {
                document.execCommand('copy');
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
        
        // Show create client result
        function showCreateResult(message, type) {
            const resultDiv = document.getElementById('createClientResult');
            const className = type === 'success' ? 'success-message' : 'error-message';
            resultDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        // Clear create client form
        function clearCreateForm() {
            document.getElementById('newClientId').value = '';
            document.getElementById('newClientName').value = '';
            document.getElementById('tempPassword').value = '';
            document.getElementById('newClientPackage').selectedIndex = 0;
        }
        
        // Load clients list for admin
        async function loadClientsList() {
            const clientsDiv = document.getElementById('clientsList');
            
            try {
                // Demo clients list
                const demoClients = [
                    { id: 'CLIENT001', name: 'ABC Company B.V.', package: 'Pro Lead Generation', status: 'Active' },
                    { id: 'CLIENT002', name: 'XYZ Startup', package: 'Basic Email Marketing', status: 'Active' }
                ];
                
                let clientsHtml = '<div class="clients-list">';
                demoClients.forEach(client => {
                    clientsHtml += `
                        <div class="client-item">
                            <div class="client-info">
                                <span><strong>${client.id}</strong> - ${client.name}</span>
                                <span>Package: ${client.package}</span>
                                <span>Status: ${client.status}</span>
                            </div>
                            <div class="client-actions">
                                <button onclick="resetClientPassword('${client.id}')" class="admin-btn">üîë Reset Password</button>
                            </div>
                        </div>
                    `;
                });
                clientsHtml += '</div>';
                
                clientsDiv.innerHTML = clientsHtml;
                
            } catch (error) {
                clientsDiv.innerHTML = '<div class="error-message">Failed to load clients list</div>';
            }
        }
        
        // Reset client password (placeholder)
        function resetClientPassword(clientId) {
            if (confirm(`Reset password for ${clientId}? This will generate a new temporary password.`)) {
                alert(`Password reset functionality would trigger N8N webhook for ${clientId}`);
                // This would call your change-password webhook
            }
        }
    </script>
</body>
</html>
