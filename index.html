<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking N8N - Client Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .client-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        input {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
        }

        button {
            padding: 12px 24px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard.active {
            display: grid;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .client-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.8);
            font-size: 14px;
            padding: 8px 16px;
            display: none;
        }

        .logout-btn.active {
            display: block;
        }

        .admin-panel {
            border: 2px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            grid-column: 1 / -1;
        }

        .workflow-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .workflow-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .workflow-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-active {
            color: #4ade80;
        }

        .status-inactive {
            color: #ef4444;
        }

        .access-level {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .client-input {
                flex-direction: column;
            }
            
            input {
                min-width: 250px;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚öîÔ∏è The Viking Webdesign</div>
            <div>N8N Lead Generation & Email Marketing Dashboard</div>
        </div>

        <div class="login-section" id="loginSection">
            <h2>üîê Secure Client Login</h2>
            <p style="margin-bottom: 20px;">Enter your credentials to access your dashboard</p>
            <div class="client-input">
                <input type="text" id="clientId" placeholder="Client ID" />
                <input type="password" id="clientPassword" placeholder="Password" />
                <button onclick="authenticateClient()" id="loginBtn">
                    <span id="loginText">üìä Login</span>
                </button>
            </div>
            <div id="errorMessage"></div>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Admin Panel (Only for VIKING001) -->
            <div class="card admin-panel" id="adminPanel" style="display: none;">
                <h3>‚öîÔ∏è Admin Panel</h3>
                <p style="margin-bottom: 20px;">Full system access and client management tools</p>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px;">
                    <p><strong>Admin Features:</strong></p>
                    <p>‚Ä¢ Create and manage clients</p>
                    <p>‚Ä¢ View all workflow statistics</p>
                    <p>‚Ä¢ Generate setup links</p>
                    <p>‚Ä¢ System monitoring and analytics</p>
                </div>
            </div>

            <!-- Client Info -->
            <div class="card">
                <h3>üë§ Client Information</h3>
                <div class="client-info">
                    <div><strong>Client:</strong> <span id="clientName">-</span></div>
                    <div><strong>Package:</strong> <span id="clientPackage">-</span></div>
                    <div><strong>Role:</strong> <span id="clientRole">-</span></div>
                    <div><strong>Active since:</strong> <span id="clientSince">-</span></div>
                    <div><strong>Session:</strong> <span id="sessionInfo">Secure connection</span></div>
                </div>
            </div>

            <!-- Accessible Workflows -->
            <div class="card" id="workflowCard">
                <h3>üîß Your Workflows</h3>
                <div id="workflowStatus">
                    <!-- Workflows will be loaded here -->
                </div>
            </div>

            <!-- Workflow Statistics -->
            <div class="card">
                <h3>‚öôÔ∏è N8N Workflow Status</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="activeWorkflows">-</div>
                        <div class="stat-label">Active Workflows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalExecutions">-</div>
                        <div class="stat-label">Total Executions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="successRate">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lastRun">-</div>
                        <div class="stat-label">Last Run</div>
                    </div>
                </div>
            </div>

            <!-- Lead Generation -->
            <div class="card">
                <h3>üéØ Lead Generation (Today)</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="newLeads">-</div>
                        <div class="stat-label">New Leads</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="qualifiedLeads">-</div>
                        <div class="stat-label">Qualified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalLeads">-</div>
                        <div class="stat-label">Total Database</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="conversionRate">-</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                </div>
            </div>

            <!-- Email Campaigns -->
            <div class="card">
                <h3>üìß Email Campaign Results</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="emailsSent">-</div>
                        <div class="stat-label">Emails Sent</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsOpened">-</div>
                        <div class="stat-label">Opened</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsClicked">-</div>
                        <div class="stat-label">Clicked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsReplied">-</div>
                        <div class="stat-label">Replied</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="logout-btn" id="logoutBtn" onclick="logout()">üö™ Logout</button>
    </div>

    <script>
        // N8N API Configuration
        const N8N_API_BASE = 'https://n8n.thevikingwebdesign.com/webhook';
        
        let currentSession = null;
        let userPermissions = null;

        // Authentication function
        async function authenticateClient() {
            const clientId = document.getElementById('clientId').value.trim();
            const password = document.getElementById('clientPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('errorMessage');
            
            // Clear previous errors
            errorDiv.innerHTML = '';
            
            // Validation
            if (!clientId || !password) {
                showError('Please enter both Client ID and Password');
                return;
            }
            
            // Show loading
            loginBtn.disabled = true;
            document.getElementById('loginText').innerHTML = '<span class="loading"></span> Authenticating...';
            
            try {
                console.log('üîê Attempting authentication for:', clientId);
                
                // Try N8N API first
                const response = await fetch(`${N8N_API_BASE}/client-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('‚úÖ N8N Authentication successful');
                        currentSession = data;
                        showDashboard(data);
                        await loadUserPermissions(clientId);
                        return;
                    }
                }
                
                // Fallback to local authentication
                console.log('üîÑ Using local authentication');
                const localAuth = authenticateLocally(clientId, password);
                if (localAuth.success) {
                    console.log('‚úÖ Local authentication successful');
                    currentSession = localAuth;
                    showDashboard(localAuth);
                    loadLocalPermissions(clientId);
                } else {
                    showError('Invalid credentials. Please check your Client ID and Password.');
                }
                
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Fallback to local authentication
                const localAuth = authenticateLocally(clientId, password);
                if (localAuth.success) {
                    console.log('‚úÖ Local authentication successful (fallback)');
                    currentSession = localAuth;
                    showDashboard(localAuth);
                    loadLocalPermissions(clientId);
                } else {
                    showError('Connection error. Please check your credentials and try again.');
                }
            } finally {
                // Reset button
                loginBtn.disabled = false;
                document.getElementById('loginText').innerHTML = 'üìä Login';
            }
        }

        // Local authentication with correct credentials
        function authenticateLocally(clientId, password) {
            const credentials = {
                'VIKING001': { 
                    password: 'viking2025', 
                    name: 'The Viking Webdesign', 
                    package: 'Owner Full Access',
                    role: 'owner'
                },
                'CLIENT001': { 
                    password: 'client123', 
                    name: 'ABC Company B.V.', 
                    package: 'Pro Lead Generation',
                    role: 'premium_client'
                },
                'CLIENT002': { 
                    password: 'startup456', 
                    name: 'XYZ Startup', 
                    package: 'Pro Lead Generation',
                    role: 'basic_client'
                }
            };
            
            const client = credentials[clientId.toUpperCase()];
            if (client && client.password === password) {
                return {
                    success: true,
                    client_id: clientId.toUpperCase(),
                    client_name: client.name,
                    package_type: client.package,
                    role: client.role,
                    active_since: '2025-07-04',
                    session_token: `local_${clientId}_${Date.now()}`
                };
            }
            
            return { success: false, message: 'Invalid credentials' };
        }

        // Load user permissions
        async function loadUserPermissions(clientId) {
            try {
                const response = await fetch(`${N8N_API_BASE}/check-permissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        permission: 'view_all_workflows'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userPermissions = data;
                    configureDashboard(data);
                } else {
                    loadLocalPermissions(clientId);
                }
            } catch (error) {
                console.error('Failed to load permissions:', error);
                loadLocalPermissions(clientId);
            }
        }

        // Load local permissions for fallback
        function loadLocalPermissions(clientId) {
            if (clientId === 'VIKING001') {
                userPermissions = {
                    role: 'owner',
                    accessible_workflows: [
                        { workflow_name: 'Lead Generation 2.0', access_level: 'admin', is_active: true },
                        { workflow_name: 'Email Marketing Automation', access_level: 'admin', is_active: true },
                        { workflow_name: 'Follow-up Sequences', access_level: 'admin', is_active: true },
                        { workflow_name: 'Database Cleanup', access_level: 'admin', is_active: true },
                        { workflow_name: 'Daily Reports', access_level: 'admin', is_active: true }
                    ]
                };
            } else if (clientId === 'CLIENT001') {
                userPermissions = {
                    role: 'premium_client',
                    accessible_workflows: [
                        { workflow_name: 'Lead Generation 2.0', access_level: 'read', is_active: true },
                        { workflow_name: 'Email Marketing Automation', access_level: 'read', is_active: true },
                        { workflow_name: 'Follow-up Sequences', access_level: 'read', is_active: true }
                    ]
                };
            } else {
                userPermissions = {
                    role: 'basic_client',
                    accessible_workflows: [
                        { workflow_name: 'Lead Generation 2.0', access_level: 'read', is_active: true },
                        { workflow_name: 'Email Marketing Automation', access_level: 'read', is_active: false }
                    ]
                };
            }
            
            configureDashboard(userPermissions);
        }

        // Configure dashboard based on permissions
        function configureDashboard(permissionData) {
            const { role, accessible_workflows } = permissionData;
            
            // Show/hide admin panel
            if (role === 'owner') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('clientRole').textContent = 'Owner';
            } else {
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('clientRole').textContent = role === 'premium_client' ? 'Premium Client' : 'Basic Client';
            }
            
            // Show accessible workflows
            if (accessible_workflows && accessible_workflows.length > 0) {
                showWorkflowStatus(accessible_workflows);
            }
            
            // Load demo data
            loadDemoData(currentSession.client_id);
        }

        // Show workflow status
        function showWorkflowStatus(workflows) {
            const workflowContainer = document.getElementById('workflowStatus');
            workflowContainer.innerHTML = '';
            
            workflows.forEach(workflow => {
                const workflowElement = createWorkflowElement(workflow);
                workflowContainer.appendChild(workflowElement);
            });
        }

        // Create workflow element
        function createWorkflowElement(workflow) {
            const div = document.createElement('div');
            div.className = 'workflow-item';
            
            const statusClass = workflow.is_active ? 'status-active' : 'status-inactive';
            const statusText = workflow.is_active ? 'üü¢ Active' : 'üî¥ Inactive';
            const accessIcon = getAccessIcon(workflow.access_level);
            
            div.innerHTML = `
                <div class="workflow-status">
                    <div>
                        <strong>${workflow.workflow_name}</strong>
                        <div class="access-level">${accessIcon} ${workflow.access_level} access</div>
                    </div>
                    <div class="${statusClass}">
                        ${statusText}
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => {
                alert(`üìä Workflow: ${workflow.workflow_name}\n\nüîß Status: ${workflow.is_active ? 'Active' : 'Inactive'}\nüîë Access: ${workflow.access_level}\n\n(Detailed workflow logs would be shown here)`);
            });
            
            return div;
        }

        // Get access level icon
        function getAccessIcon(accessLevel) {
            switch(accessLevel) {
                case 'admin': return '‚öîÔ∏è';
                case 'write': return '‚úèÔ∏è';
                case 'read': return 'üëÅÔ∏è';
                default: return '‚ùì';
            }
        }
        
        // Show dashboard after successful login
        function showDashboard(sessionData) {
            console.log('üìä Showing dashboard for:', sessionData.client_name);
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('logoutBtn').classList.add('active');
            
            // Update client info
            document.getElementById('clientName').textContent = sessionData.client_name;
            document.getElementById('clientPackage').textContent = sessionData.package_type;
            document.getElementById('clientSince').textContent = sessionData.active_since;
            document.getElementById('sessionInfo').textContent = 'Secure connection ‚úÖ';
        }
        
        // Load demo data based on client
        function loadDemoData(clientId) {
            console.log('üìà Loading data for:', clientId);
            
            const demoData = {
                'VIKING001': { 
                    workflows: 8, 
                    executions: 1247, 
                    newLeads: 23, 
                    emailsSent: 156,
                    successRate: '98.2%',
                    totalLeads: '1,456',
                    conversionRate: '12.8%'
                },
                'CLIENT001': { 
                    workflows: 5, 
                    executions: 892, 
                    newLeads: 15, 
                    emailsSent: 98,
                    successRate: '97.1%',
                    totalLeads: '847',
                    conversionRate: '14.2%'
                },
                'CLIENT002': { 
                    workflows: 3, 
                    executions: 445, 
                    newLeads: 8, 
                    emailsSent: 45,
                    successRate: '95.8%',
                    totalLeads: '324',
                    conversionRate: '11.5%'
                }
            };
            
            const data = demoData[clientId] || demoData['CLIENT001'];
            
            // Update workflow statistics
            document.getElementById('activeWorkflows').textContent = data.workflows;
            document.getElementById('totalExecutions').textContent = data.executions.toLocaleString();
            document.getElementById('successRate').textContent = data.successRate;
            document.getElementById('lastRun').textContent = '2 min';
            
            // Update lead generation
            document.getElementById('newLeads').textContent = data.newLeads;
            document.getElementById('qualifiedLeads').textContent = Math.floor(data.newLeads * 0.8);
            document.getElementById('totalLeads').textContent = data.totalLeads;
            document.getElementById('conversionRate').textContent = data.conversionRate;
            
            // Update email campaigns
            document.getElementById('emailsSent').textContent = data.emailsSent;
            document.getElementById('emailsOpened').textContent = Math.floor(data.emailsSent * 0.57);
            document.getElementById('emailsClicked').textContent = Math.floor(data.emailsSent * 0.15);
            document.getElementById('emailsReplied').textContent = Math.floor(data.emailsSent * 0.04);
        }
        
        // Error display
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
        }
        
        // Logout function
        function logout() {
            console.log('üö™ Logging out');
            currentSession = null;
            userPermissions = null;
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('logoutBtn').classList.remove('active');
            document.getElementById('adminPanel').style.display = 'none';
            
            // Clear form
            document.getElementById('clientId').value = '';
            document.getElementById('clientPassword').value = '';
            document.getElementById('errorMessage').innerHTML = '';
        }
        
        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('dashboard').classList.contains('active')) {
                authenticateClient();
            }
        });
    </script>
</body>
</html>
