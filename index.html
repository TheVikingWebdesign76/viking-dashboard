<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking N8N - Client Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .client-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        input {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
        }

        button {
            padding: 12px 24px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard.active {
            display: grid;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .client-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.8);
            font-size: 14px;
            padding: 8px 16px;
            display: none;
        }

        .logout-btn.active {
            display: block;
        }

        .admin-panel {
            border: 2px solid #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            grid-column: 1 / -1;
        }

        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ff6b35;
        }

        .admin-section h4 {
            margin-bottom: 15px;
            color: #ff6b35;
            font-size: 1.1rem;
        }

        .create-client-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row input, .form-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
        }

        .form-row input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .admin-btn {
            background: #ff6b35;
            padding: 12px 20px;
            font-size: 14px;
        }

        .admin-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .setup-link-container {
            background: rgba(74, 222, 128, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4ade80;
        }

        .link-display {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .link-display input {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 5px;
        }

        .copy-btn {
            padding: 10px 15px;
            background: #4ade80;
            font-size: 12px;
        }

        .setup-instructions {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .success-message {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4ade80;
        }

        .clients-list {
            display: grid;
            gap: 10px;
        }

        .client-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-info span {
            display: block;
            margin-bottom: 5px;
        }

        .client-actions {
            display: flex;
            gap: 10px;
        }

        .client-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .workflow-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .workflow-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .workflow-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-active {
            color: #4ade80;
        }

        .status-inactive {
            color: #ef4444;
        }

        .access-level {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .client-input {
                flex-direction: column;
            }
            
            input {
                min-width: 250px;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚öîÔ∏è The Viking Webdesign</div>
            <div>N8N Lead Generation & Email Marketing Dashboard</div>
        </div>

        <div class="login-section" id="loginSection">
            <h2>üîê Secure Client Login</h2>
            <p style="margin-bottom: 20px;">Enter your credentials to access your dashboard</p>
            <div class="client-input">
                <input type="text" id="clientId" placeholder="Client ID" />
                <input type="password" id="clientPassword" placeholder="Password" />
                <button onclick="authenticateClient()" id="loginBtn">
                    <span id="loginText">üìä Login</span>
                </button>
            </div>
            <div id="errorMessage"></div>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Admin Panel (Only for VIKING001) -->
            <div class="card admin-panel" id="adminPanel" style="display: none;">
                <h3>‚öîÔ∏è Admin Panel</h3>
                
                <!-- Create Client Section -->
                <div class="admin-section">
                    <h4>üë• Create New Client</h4>
                    <div class="create-client-form">
                        <div class="form-row">
                            <input type="text" id="newClientId" placeholder="Client ID (e.g: CLIENT004)" />
                            <input type="text" id="newClientName" placeholder="Client Name" />
                        </div>
                        <div class="form-row">
                            <select id="newClientPackage">
                                <option value="Pro Lead Generation">Pro Lead Generation</option>
                                <option value="Enterprise Solution">Enterprise Solution</option>
                            </select>
                            <input type="text" id="tempPassword" placeholder="Temporary Password" />
                        </div>
                        <button onclick="createNewClient()" id="createClientBtn" class="admin-btn">
                            <span id="createClientText">üÜï Create Client</span>
                        </button>
                    </div>
                    <div id="createClientResult"></div>
                </div>

                <!-- Generated Setup Link -->
                <div class="admin-section" id="setupLinkSection" style="display: none;">
                    <h4>üîó Client Setup Link</h4>
                    <div class="setup-link-container">
                        <p>Send this link to your new client:</p>
                        <div class="link-display">
                            <input type="text" id="setupLink" readonly />
                            <button onclick="copySetupLink()" class="copy-btn">üìã Copy</button>
                        </div>
                        <p class="setup-instructions">
                            The client will use this link to set their own secure password.
                        </p>
                    </div>
                </div>

                <!-- Client Management -->
                <div class="admin-section">
                    <h4>üìä Client Overview</h4>
                    <div id="clientsList">
                        <div class="loading-clients">Loading clients...</div>
                    </div>
                </div>
            </div>

            <!-- Client Info -->
            <div class="card">
                <h3>üë§ Client Information</h3>
                <div class="client-info">
                    <div><strong>Client:</strong> <span id="clientName">-</span></div>
                    <div><strong>Package:</strong> <span id="clientPackage">-</span></div>
                    <div><strong>Role:</strong> <span id="clientRole">-</span></div>
                    <div><strong>Active since:</strong> <span id="clientSince">-</span></div>
                    <div><strong>Session:</strong> <span id="sessionInfo">Secure connection</span></div>
                </div>
            </div>

            <!-- Accessible Workflows -->
            <div class="card" id="workflowCard" style="display: none;">
                <h3>üîß Your Workflows</h3>
                <div id="workflowStatus">
                    <div class="loading">Loading workflows...</div>
                </div>
            </div>

            <!-- Workflow Statistics -->
            <div class="card">
                <h3>‚öôÔ∏è N8N Workflow Status</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="activeWorkflows">-</div>
                        <div class="stat-label">Active Workflows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalExecutions">-</div>
                        <div class="stat-label">Total Executions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="successRate">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lastRun">-</div>
                        <div class="stat-label">Last Run</div>
                    </div>
                </div>
            </div>

            <!-- Lead Generation -->
            <div class="card">
                <h3>üéØ Lead Generation (Today)</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="newLeads">-</div>
                        <div class="stat-label">New Leads</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="qualifiedLeads">-</div>
                        <div class="stat-label">Qualified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalLeads">-</div>
                        <div class="stat-label">Total Database</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="conversionRate">-</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                </div>
            </div>

            <!-- Email Campaigns -->
            <div class="card">
                <h3>üìß Email Campaign Results</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="emailsSent">-</div>
                        <div class="stat-label">Emails Sent</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsOpened">-</div>
                        <div class="stat-label">Opened</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsClicked">-</div>
                        <div class="stat-label">Clicked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="emailsReplied">-</div>
                        <div class="stat-label">Replied</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="logout-btn" id="logoutBtn" onclick="logout()">üö™ Logout</button>
    </div>

    <script>
        // N8N API Configuration
        const N8N_API_BASE = 'https://n8n.thevikingwebdesign.com/webhook';
        
        let currentSession = null;
        let userPermissions = null;
        let userWorkflows = [];

        // Authentication function with debug logging
        async function authenticateClient() {
            const clientId = document.getElementById('clientId').value.trim();
            const password = document.getElementById('clientPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('errorMessage');
            
            // Clear previous errors
            errorDiv.innerHTML = '';
            
            // Validation
            if (!clientId || !password) {
                showError('Please enter both Client ID and Password');
                return;
            }
            
            // Show loading
            loginBtn.disabled = true;
            document.getElementById('loginText').innerHTML = '<span class="loading"></span> Authenticating...';
            
            try {
                console.log('Attempting N8N authentication...');
                
                // Call N8N authentication API
                const response = await fetch(`${N8N_API_BASE}/client-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        password: password
                    })
                });
                
                console.log('N8N Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('N8N Response data:', data);
                
                if (data.success) {
                    // Authentication successful
                    console.log('‚úÖ N8N Authentication successful');
                    currentSession = data;
                    showDashboard(data);
                    
                    // Load permissions after successful authentication
                    await loadUserPermissions(data.client_id || clientId);
                    
                } else {
                    // Authentication failed
                    console.log('‚ùå N8N Authentication failed:', data.message);
                    showError(data.message || 'Invalid credentials');
                }
                
            } catch (error) {
                console.error('N8N API error:', error);
                console.log('üîÑ Falling back to local authentication');
                
                // Fallback to local authentication
                const localAuth = authenticateLocally(clientId, password);
                if (localAuth.success) {
                    console.log('‚úÖ Local authentication successful');
                    currentSession = localAuth;
                    showDashboard(localAuth);
                    
                    // Mock permissions for local auth
                    mockUserPermissions(localAuth.client_id);
                } else {
                    console.log('‚ùå Local authentication failed');
                    showError('Connection error. Please check your credentials and try again.');
                }
            } finally {
                // Reset button
                loginBtn.disabled = false;
                document.getElementById('loginText').innerHTML = 'üìä Login';
            }
        }

        // Load user permissions from N8N
        async function loadUserPermissions(clientId) {
            try {
                console.log('üîç Loading permissions for:', clientId);
                
                const response = await fetch(`${N8N_API_BASE}/check-permissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        permission: 'view_all_workflows'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Permission check failed: ${response.status}`);
                }
                
                const data = await response.json();
                userPermissions = data;
                userWorkflows = data.accessible_workflows || [];
                
                console.log('üë§ User role:', data.role);
                console.log('üîß Accessible workflows:', userWorkflows.length);
                
                // Configure dashboard based on permissions
                configureDashboard(data);
                
            } catch (error) {
                console.error('Failed to load permissions:', error);
                console.log('üîÑ Using fallback permissions');
                
                // Fallback permissions
                mockUserPermissions(clientId);
            }
        }

        // Mock permissions for fallback
        function mockUserPermissions(clientId) {
            if (clientId === 'VIKING001') {
                userPermissions = {
                    role: 'owner',
                    has_requested_permission: true,
                    accessible_workflows: [
                        { workflow_name: 'Lead Generation 2.0', access_level: 'admin', is_active: true },
                        { workflow_name: 'Email Marketing Automation', access_level: 'admin', is_active: true },
                        { workflow_name: 'Follow-up Sequences', access_level: 'admin', is_active: true }
                    ]
                };
            } else {
                userPermissions = {
                    role: 'client_premium',
                    has_requested_permission: false,
                    accessible_workflows: [
                        { workflow_name: 'Lead Generation 2.0', access_level: 'read', is_active: true },
                        { workflow_name: 'Email Marketing Automation', access_level: 'read', is_active: true }
                    ]
                };
            }
            
            userWorkflows = userPermissions.accessible_workflows;
            configureDashboard(userPermissions);
        }

        // Configure dashboard based on permissions
        function configureDashboard(permissionData) {
            const { role, accessible_workflows } = permissionData;
            
            console.log('üéõÔ∏è Configuring dashboard for role:', role);
            
            // Show/hide admin panel
            if (role === 'owner') {
                document.getElementById('adminPanel').style.display = 'block';
                console.log('‚öîÔ∏è Owner access - admin panel enabled');
            } else {
                document.getElementById('adminPanel').style.display = 'none';
                console.log('üë§ Premium client - admin panel hidden');
            }
            
            // Update client role display
            document.getElementById('clientRole').textContent = role === 'owner' ? 'Owner' : 'Premium Client';
            
            // Show accessible workflows
            if (accessible_workflows && accessible_workflows.length > 0) {
                showWorkflowStatus(accessible_workflows);
            }
            
            // Load appropriate demo data
            loadDemoData(currentSession.client_id);
        }

        // Show workflow status
        function showWorkflowStatus(workflows) {
            const workflowCard = document.getElementById('workflowCard');
            const workflowContainer = document.getElementById('workflowStatus');
            
            workflowCard.style.display = 'block';
            workflowContainer.innerHTML = '';
            
            console.log('üîß Showing workflows:', workflows.map(w => w.workflow_name));
            
            workflows.forEach(workflow => {
                const workflowElement = createWorkflowElement(workflow);
                workflowContainer.appendChild(workflowElement);
            });
        }

        // Create workflow element
        function createWorkflowElement(workflow) {
            const div = document.createElement('div');
            div.className = 'workflow-item';
            div.dataset.workflowName = workflow.workflow_name;
            
            const statusClass = workflow.is_active ? 'status-active' : 'status-inactive';
            const statusText = workflow.is_active ? 'üü¢ Active' : 'üî¥ Inactive';
            const accessIcon = getAccessIcon(workflow.access_level);
            
            div.innerHTML = `
                <div class="workflow-status">
                    <div>
                        <strong>${workflow.workflow_name}</strong>
                        <div class="access-level">${accessIcon} ${workflow.access_level} access</div>
                    </div>
                    <div class="${statusClass}">
                        ${statusText}
                    </div>
                </div>
            `;
            
            // Add click handler for workflow details
            div.addEventListener('click', () => {
                showWorkflowDetails(workflow);
            });
            
            return div;
        }

        // Get access level icon
        function getAccessIcon(accessLevel) {
            switch(accessLevel) {
                case 'admin': return '‚öîÔ∏è';
                case 'write': return '‚úèÔ∏è';
                case 'read': return 'üëÅÔ∏è';
                default: return '‚ùì';
            }
        }

        // Show workflow details
        function showWorkflowDetails(workflow) {
            const canViewDetails = userPermissions?.role === 'owner' || workflow.access_level !== 'read';
            
            if (!canViewDetails) {
                showError('You have read-only access to this workflow');
                return;
            }
            
            alert(`üìä Workflow: ${workflow.workflow_name}\n\nüîß Status: ${workflow.is_active ? 'Active' : 'Inactive'}\nüîë Access: ${workflow.access_level}\n\n(Detailed workflow logs would be shown here)`);
        }
        
        // Local fallback authentication
        function authenticateLocally(clientId, password) {
            const credentials = {
                'VIKING001': { password: 'viking2025', name: 'The Viking Webdesign', package: 'Owner Full Access' },
                'CLIENT001': { password: 'client123', name: 'ABC Company B.V.', package: 'Pro Lead Generation' },
                'CLIENT002': { password: 'startup456', name: 'XYZ Startup', package: 'Pro Lead Generation' }
            };
            
            const client = credentials[clientId.toUpperCase()];
            if (client && client.password === password) {
                return {
                    success: true,
                    client_id: clientId.toUpperCase(),
                    client_name: client.name,
                    package_type: client.package,
                    active_since: '2025-07-04',
                    session_token: `local_${clientId}_${Date.now()}`
                };
            }
            
            return { success: false, message: 'Invalid credentials' };
        }
        
        // Show dashboard after successful login
        function showDashboard(sessionData) {
            console.log('üìä Showing dashboard for:', sessionData.client_name);
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('logoutBtn').classList.add('active');
            
            // Update client info
            document.getElementById('clientName').textContent = sessionData.client_name;
            document.getElementById('clientPackage').textContent = sessionData.package_type;
            document.getElementById('clientSince').textContent = sessionData.active_since;
            document.getElementById('sessionInfo').textContent = 'Secure connection ‚úÖ';
        }
        
        // Load demo data
        function loadDemoData(clientId) {
            console.log('üìà Loading demo data for:', clientId);
            
            const demoData = {
                'VIKING001': { workflows: 8, executions: 1247, newLeads: 23, emailsSent: 156 },
                'CLIENT001': { workflows: 5, executions: 892, newLeads: 15, emailsSent: 98 },
                'CLIENT002': { workflows: 3, executions: 445, newLeads: 8, emailsSent: 45 }
            };
            
            const data = demoData[clientId] || demoData['CLIENT001'];
            
            document.getElementById('activeWorkflows').textContent = data.workflows;
            document.getElementById('totalExecutions').textContent = data.executions.toLocaleString();
            document.getElementById('successRate').textContent = '98.2%';
            document.getElementById('newLeads').textContent = data.newLeads;
            document.getElementById('qualifiedLeads').textContent = Math.floor(data.newLeads * 0.8);
            document.getElementById('totalLeads').textContent = '1,456';
            document.getElementById('conversionRate').textContent = '12.8%';
            document.getElementById('emailsSent').textContent = data.emailsSent;
            document.getElementById('emailsOpened').textContent = Math.floor(data.emailsSent * 0.57);
            document.getElementById('emailsClicked').textContent = Math.floor(data.emailsSent * 0.15);
            document.getElementById('emailsReplied').textContent = Math.floor(data.emailsSent * 0.04);
            document.getElementById('lastRun').textContent = '2 min';
        }
        
        // Error display
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
        }
        
        // Logout function
        function logout() {
            console.log('üö™ Logging out');
            currentSession = null;
            userPermissions = null;
            userWorkflows = [];
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('logoutBtn').classList.remove('active');
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('workflowCard').style.display = 'none';
            document.getElementById('clientId').value = '';
            document.getElementById('clientPassword').value = '';
            document.getElementById('errorMessage').innerHTML = '';
        }
        
        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('dashboard').classList.contains('active')) {
                authenticateClient();
            }
        });
